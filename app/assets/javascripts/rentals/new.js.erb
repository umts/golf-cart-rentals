function isEmpty(str) {
  return (!str || 0 === str.length);
}

function getActiveTab() {
  return $("div.tab-pane.active").attr('id');
}

function costCalculation(){
  var activeTab = getActiveTab();
  var raw_item_type = null;
  var raw_start_time = null;
  var raw_end_time = null;
  var amount = null;

  if(activeTab == "single_day") {
    raw_item_type = $('#single_item_type_id').val();
    raw_start_time = $('#single_start_time').val();
    raw_end_time = $('#single_start_time').val(); <% #force it to be one day %>
    amount = $('#single_amount');
  } else { //must be on multiple tab
    raw_item_type = $('#multiple_item_type_id').val();
    raw_start_time = $('#multiple_start_time').val();
    raw_end_time = $('#multiple_end_time').val();
    amount = $('#multiple_amount');
  }

  if(!isEmpty(raw_item_type) && !isEmpty(raw_end_time) && !isEmpty(raw_start_time)) {
    if(new Date(raw_start_time) > new Date(raw_end_time)) {
      alert('Pickup Date must occur before Dropoff date');
    } else {
      $.ajax({
        url: Routes.rentals_cost_path(),
        dataType: 'json',
        data: { item_type: raw_item_type, start_time: raw_start_time, end_time: raw_end_time },
        success: function (data) {
          amount.val(data);
        },
        error: function () {
          alert('failed to retreive rental cost');
        }
      });
    }
  }
}

function userResultHandleClick(e) {
  var userId = e.currentTarget.id.substr(10); //select the user id
  getActiveTab() == "single_day" ? $("#single_user_id").val(userId) : $("#multiple_user_id").val(userId); //set user id
  
  var row = $(e.currentTarget.parentNode.parentNode); //select the row
  var name = row.find("td:nth-child(1)").text() + " " + row.find("td:nth-child(2)").text(); //first two td's joined by space
  getActiveTab() == "single_day" ? $("#single_userSearchQuery").val(name) : $("#multiple_userSearchQuery").val(name); //set the user to the full name

  $("#modalSearchResults").modal('toggle'); //close modal
}

function ajaxUserSearch(pageNo) {
  var query = getActiveTab() == "single_day" ? $("#single_userSearchQuery").val() : $("#multiple_userSearchQuery").val();
  var params = $.extend({user_search_query: query}, pageNo ? {page: pageNo} : {page: "1"} );
  $.ajax({
    url: Routes.rentals_search_users_path(),
    dataType: "html",
    data: params,
    success: function (data) {
      $("#userResults").html(data); //put content in the modal
      
      //attach event listeners to results
      $(".userResult").click(userResultHandleClick);

      //need to reformat links
      $("#userResults .pagination a").each(modalSearchResultsFormatPaginationLinks);
    },
    error: function () {
      alert("Failed to retreive users.");
    }
  });
}

function modalSearchResultsFormatPaginationLinks(undefined, link) {
  link = $(link); //jquery that
  var pageNo = link.attr("href").split("&")[0].split("?")[1].split("=")[1]; //works universially to pull pageNo out of link
  link.attr("href", "#"); //remove navigation
  link.click(function () { ajaxUserSearch(pageNo); } ); 
}

$(document).ready( function () {
  costCalculation(); //initial cost calculaton

  // ~ cost calcultion hooks
  $('input.cost-dependent').on('blur', function () {
    costCalculation();
  });

  $('select.cost-dependent').on('change', function () {
    costCalculation();
  });

  $("a[href='#multiple_day']").on('shown.bs.tab', function () {
    costCalculation();
  });

  $("input[id$='amount']").change(function () {
    alert('Warning! You are overriding the system defaults.');
  });


  // ~ user searching

  //enter key performs click on search for ease of use
  $(".userSearchQuery").keypress(function (key) {
    if(key.which === 13) {
      $("#modalSearchResults").modal('toggle'); //open modal
    }
  });

  //bind search to modal open
  $("#modalSearchResults").on("shown.bs.modal", function () { ajaxUserSearch() });
});
